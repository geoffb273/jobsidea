<style>
	body {
		justify-content: center;
	}
	#profilePic {
		height: 25vmin;
		width: 25vmin;
		border-radius: 150px;
		margin-top: 3vmin;
		margin-bottom: 2.5vw;
		margin-left: 2vw;
		margin-right: 1.5vw;
		background: #afb8c2;
		border: solid 0.1vmin;
		min-width: 150px;
		min-height: 150px;
	}
	
	#header {
		width: 80vw;
		display: flex;
		border-bottom: 0.5px solid;
		margin-top: 1.5vh;
		background: white;
		border-radius: 5vmin;
		margin-left: 10vw;
	}
	
	#header > #info {
		font-size: max(16px, 2vmin);
	}
	
	#header > #rightheader {
		display: flex;
		flex-direction: column;
		position: absolute;
		right: 10vw;
	}
	#header > #rightheader > button {
		background: black;
		color: white;
		border-radius: 5vmin;
		margin-right: 1.5vw;
		font-size: max(12px, 2vmin);
	}
	
	#header > #rightheader > form > #chatButton {
		background: black;
		color: white;
		border-radius: 5vmin;
		margin-right: 1.5vw;
		font-size: max(16px, 2vmin);
		margin-top: max(12.5vmin, 40px);
	}
	
	#header > #rightheader > #upload {
		margin-top: max(10vmin, 40px);
	}
	
	label {
		margin-top: max(10vmin, 40px);
		cursor: pointer;
		background: black;
		color: white;
		padding-right: 10px;
		padding-left: 10px;
		margin-right: 1.5vw;
		border-radius: 5vmin;
		font-size: max(12px, 2vmin);
		width: 12vw;
		padding-top: 2.5px;
		padding-bottom: 2.5px;
	}

	#upload-photo {
		opacity: 0;
		position: absolute;
		z-index: -1;
	}
	
	@media only screen and (max-width: 700px) {
		#header {
			left: 0;
			margin-left: 0;
			width: 98vw;
		}
		
		#profilePic {
			height: 20vmin;
			width: 20vmin;
			min-width: 25px;
			min-height: 25px;
			margin-top: 7.5vmin;
		}
		
		#header > #rightheader {
			right: 2.5vw;
		}
	}
	
	#reviews-div {
		max-width: 100vw;
		height: max(23vh, 135px);
		max-height: 170px;
		overflow-x: auto;
		display: flex;
		font-size: 14px;
	}
	.review {
		position: relative;
		margin-top: 10px;
		background: white;
		width: max(20vw, 300px);
		min-width: max(25vw, 300px);
		border-radius: 20px;
		height: max(20vh, 115px);
		max-height: 150px;
		margin-bottom: 10px;
		border: 0.5px solid;
		margin-right: 5px;
	}
	.profilePicRev {
		width: 35px;
		height: 35px;
		border-radius: 35px;
		margin-right: 10px;
	}
	
	.top-review {
		margin-top: 10px;
		margin-left: 10px;
		text-align: left;
		font-size: 16px;
	}
	
	.center {
		
	}
	
	.bottom-review {
		position: absolute;
		bottom: 0;
		right: 10px;
		text-align: right;
		color: gray;
	}
	
	
</style>
<meta name="viewport" content="width=device-width,initial-scale=0.8">

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<head>
	<%- include('css/style'); %>
</head>

<script src="/socket.io/socket.io.js"></script>

<script>
	var own = '<%- own%>';
	var username = '<%- username%>'
	if (own) {
		var socket = io()
		socket.emit('self room', {username: username});
	}
	
	var getProfilePic = function() {
		$.get("/user-pic/" + username, function(url) {
			var image = document.getElementById("profilePic")
			if (url.length > 0) {
				image.src = url
			}
			
		});
	}
	getProfilePic()
</script>


<div id="header">
	<img id="profilePic"></img>
	<div id="info">
	<%if (name) {%>
		<p id="name" style="font-size: max(26px, 3vw); text-align:left;"><%= name %></p>
	<%}%>
	<%if (username) {%>
		<p id="username"><i>&#64<%= username %></i></p>
	<%}%>
	<%if (email) {%>
		<p id="email"><%= email %></p>
	<%}%>
	</div>
	<div id="rightheader">
		<%if (own) {%>
				<form id="upload" method="post" enctype="multipart/form-data">
					<label for="upload-photo">Edit Profile Pic<input type="file" id="upload-photo" name="photo" accept="image/*" /></label>
				</form>
				<button id="logout" onclick="window.location.href='/login'">Log Out</button>
			
		<%} else {%>
			<form action="/chats/<%- username %>" method="post">
				<input type="submit" id="chatButton" value="Chat">
			</form>
		<%}%>
	</div>
	
</div>
<div id="reviews-div"></div>

<script>
	var reviews = [];
	var username = '<%- username%>'
	var own = '<%- own%>'
	
	if (own && own == true) {
		var upload = document.getElementById("upload")
		
		upload.action = "/pics/" + username
		
		var photo = document.getElementById("upload-photo")
		photo.onchange = (e) => {
			upload.submit()
		}
	}

	var updateReviews = function() {
		var reviewsDiv = document.getElementById("reviews-div")
		$.get("/reviews?username=" + username, function(data) {
			data.forEach(function(review) {
				if (!reviews.includes(review.id)) {
					reviews.push(review.id);
					var reviewDiv = makeReview(review)
					reviewsDiv.appendChild(reviewDiv)
				}
				
			});
		});
		
		$.get("/stars?username=" + username, function(data) {
			if (data && data != "undefined") {
				rating.innerHTML = data + " stars";
			}
		});
	}
	
	var makeReview = function(review) {
		var reviewDiv = document.createElement("div")
		reviewDiv.className = "review"
		var top = document.createElement("div")
		top.className="top-review"
		var center = document.createElement("div")
		var bottom = document.createElement("div")
		reviewDiv.appendChild(top)
		reviewDiv.appendChild(center)
		reviewDiv.appendChild(bottom)
		
		center.style.display = "flex"
		center.style.justifyContent = "center"
		center.style.marginTop = "max(5vh, 30px)"
		center.style.marginLeft = "10px"
		center.style.marginRight = "10px"
		
		bottom.className = "bottom-review"
		
		$.get("/user-pic/" + review.author, function(data) {
			if (data) {
				top.innerHTML = "<div style='float:left'><img src=" + data + " username=" + review.author + " class='profilePicRev'></img></div>"
				top.innerHTML += "<div>" + review.name + "<i style='color:gray'>@" + review.author + "</i></div>"
			} else {
				top.innerHTML = "<span class='profilePicRev' username=" + review.author + "><i class='fa fa-user fa-xl'></i></span>"
				top.innerHTML += review.name + "<i style='color:gray'>@" + review.author + "</i>"
			}
			top.username = review.author
			top.onclick = (e) => {window.location.href='/profile/' + e.target.attributes.username.value}
			
		})
		top.innerHTML = "<span class='profilePicRev' username=" + review.author + "><i class='fa fa-user fa-xl'></i></span>"
		top.innerHTML += review.name + "<i style='color:gray'>@" + review.author + "</i>"
		center.innerHTML = review.content
		var date = (Date.now() - new Date(review.created)) / 1000
		var dateString = Math.round(date + 1) + " seconds ago"
		if (date >= 59 && date < 60 * 60) {
			dateString = Math.round(date / 60) + " minutes ago"
		} else if (date >= 60 * 60 && date < 60 * 60 * 24) {
			dateString = Math.round(date / (60 * 60)) + " hours ago"
		} else if (date >= 60 * 60 * 24 && date < 60 * 60 * 24 * (365 + 0.25)) {
			dateString = Math.round(date / (60 * 60 * 24)) + " days ago"
		} else if (date >= 60 * 60 * 24 * (365 + 0.25)) {
			dateString = Math.round(date / (60 * 60 * 24 * (365 + 0.25))) + " years ago"
		}
		bottom.innerHTML = dateString
		return (reviewDiv)
	}
	
	updateReviews();
</script>

<% if(user) { %>
<%- include('user'); %>
<% } else { %>
<%- include('restaurant'); %>
<% } %>