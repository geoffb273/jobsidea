<head>
	<%- include('css/style'); %>
	
</head>

<style>
	tr:nth-child(even) { 
		background-color: #e9f4ff; 
	}
	
	.post {
		background: white;
		margin-left: 15vw;
		min-height: 90vh;
		width: 70vw;
	}
	
	#table {
		font-size: max(16px, 1.5vw);
		width: 70vw;
		overflow-y: scroll;
	}
	.profilePic {
		border-radius: 5vmin;
		width: max(5vmin, 20px);
		height: max(5vmin, 20px);
		font-size: max(2vmin, 16px);
	}
	.chatButton {
		padding-top: 1vmin;
      	width: max(5vw, 50px);
      	height: max(4vmin, 25px);
      	border-radius: 5vmin;
      	font-size: max(2vmin, 16px);
	}
	
</style>


<div class="post">
  <table id = "table"></table>
</div>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
	var socket = io();
	
	var username = '<%- username%>'
	var table = document.getElementById("table");
	var count = 0;
	var notifications = []
	var notificationIds = []
	var limit = 30;
	
	var getNotifications = function() {
		
		$.get("/my-notifications?limit=" + limit, function(nots) {
			
			nots.forEach(notification => {
    			var i = nots.findIndex( curr => { curr.id == notification.id })
    			var content = notification.content
    			if (!notificationIds.includes(notification.id)) {
    				notificationIds.push(notification.id);
    				notifications.push(notification)
    				var row = table.insertRow(i);
					
					var date = (Date.now() - new Date(notification.created)) / 1000
					var dateString = Math.round(date + 1) + " seconds ago"
					if (date >= 59 && date < 60 * 60) {
						dateString = Math.round(date / 60) + " minutes ago"
					} else if (date >= 60 * 60 && date < 60 * 60 * 24) {
						dateString = Math.round(date / (60 * 60)) + " hours ago"
					} else if (date >= 60 * 60 * 24 && date < 60 * 60 * 24 * (365 + 0.25)) {
						dateString = Math.round(date / (60 * 60 * 24)) + " days ago"
					} else if (date >= 60 * 60 * 24 * (365 + 0.25)) {
						dateString = Math.round(date / (60 * 60 * 24 * (365 + 0.25))) + " years ago"
					}
					var u2 = notification.content.split(" ")[0]
					var cell0 = row.insertCell(0);
					
					if (notification.sender) {
						$.get("/user-pic/" + notification.sender, function(data) {
							if (data) {
								cell0.innerHTML = "<img src=" + data + " username=" + u2 + " class='profilePic'></img>"
							} else {
								cell0.innerHTML = "<span class='profilePic' username=" + u2 + "><i class='fa fa-user fa-xl'></i></span>"
							}
							cell0.style.alignSelf = "flex-end"
							cell0.onclick = (e) => {window.location.href='/profile/' + e.target.attributes.username.value}
							
						})
					} else {
						cell0.innerHTML = "<span class='profilePic'><i class='fa fa-user fa-xl'></i></span>"
						cell0.style.alignSelf = "flex-end"
						cell0.username = u2
						cell0.onclick = (e) => {window.location.href='/profile/' + e.target.attributes.username.value}
					}
					
					
					
					var cell1 = row.insertCell(1);
					cell1.innerHTML = content
					var cell2 = row.insertCell(2);
					cell2.innerHTML = dateString;
					
					var cell3 = row.insertCell(3)
					
					var chatId = username < u2 ? username + "@" + u2 : u2 + "@" + username
					
					var button = document.createElement("button");
				
					button.className = "fa-solid fa-message fa-sm chatButton"
				
					button.id = "join";
					button.chatId = chatId
					button.onclick = (e) => {window.location.href = "/chat/" + e.target.chatId}
					cell3.appendChild(button);
    			}
    		})
		});
	}
	getNotifications()
	
	var checkEnd = function() {
		
  		if (document.body.scrollTop + window.innerHeight - document.body.scrollHeight == 0) {
  			limit += 10;
      		getNotifications()
    	}
  	}
  	document.body.onscroll = checkEnd
	
	socket.emit('self room', {username: username})
	socket.on("notification", function() {
		limit += 1;
		getNotifications()
	})
</script>
