<style>
	#profilePic {
		height: 25vmin;
		width: 25vmin;
		border-radius: 150px;
		margin-top: 3vmin;
		margin-bottom: 2.5vw;
		margin-left: 2vw;
		margin-right: 1.5vw;
		background: #afb8c2;
		border: 1px solid #20537A;
		min-width: 150px;
		min-height: 150px;
	}
	
	#header {
		width: 80vw;
		display: flex;
		border-style: none solid solid none;
		border-width: 1px;
		border-color: black;
		box-shadow: 5px 5px 10px #20537A;
		margin-top: 1.5vh;
		background: white;
		//border-radius: 5vmin;
		margin-left: 10vw;
		height: 220px;
		background: white;//radial-gradient(#cedde9, #81A8C6);
	}
	
	#header > #info > #name {
		font-family: Monaco;
		font-weight: bolder;
	}
	
	#header > #info {
		font-size: max(16px, 2vmin);
	}
	
	#header > #rightheader {
		display: flex;
		flex-direction: column;
		position: absolute;
		right: 10vw;
		height: 220px;
	}
	#header > #rightheader > button {	/* #20537A #38698E #5481A4 #81A8C6 #B6D0E4 */
		background: linear-gradient(to bottom right, #20537A, #38698E, #5481A4, #81A8C6);
		color: white;
		//border-radius: 5vmin;
		margin-right: 1.5vw;
		font-size: max(12px, 2vmin);
	}
	
	#header > #rightheader > button:hover {
		background: linear-gradient(to bottom right, #cedde9, #81A8C6, #5481A4);
	}
	
	#header > #rightheader > form > #chatButton {
		background: linear-gradient(to bottom right, #20537A, #38698E, #5481A4, #81A8C6);
		color: white;
		//border-radius: 5vmin;
		margin-right: 1.5vw;
		font-size: max(16px, 2vmin);
		margin-top: 75px;
	}
	
	#header > #rightheader > form > #chatButton:hover {
		background: linear-gradient(to bottom right, #cedde9, #81A8C6, #5481A4);
	}
	
	#header > #rightheader > #upload {
		margin-top: 75px;
	}
	
	label {
		margin-top: max(10vmin, 40px);
		cursor: pointer;
		background: linear-gradient(to bottom right, #20537A, #38698E, #5481A4, #81A8C6);
		border: outset lightgray;
		color: white;
		padding-right: 10px;
		padding-left: 10px;
		margin-right: 1.5vw;
		//border-radius: 5vmin;
		font-size: max(12px, 2vmin);
		width: 12vw;
		padding-top: 2.5px;
		padding-bottom: 2.5px;
	}
	
	label:hover {
		background: linear-gradient(to bottom right, #cedde9, #81A8C6, #5481A4);
	}

	#upload-photo {
		opacity: 0;
		position: absolute;
		z-index: -1;
	}
	
	#reviews-div {
		max-width: 100vw;
		height: 170px;
		overflow-x: auto;
		display: flex;
		font-size: 14px;
		margin-left: 10px;
		margin-right: 10px;
		border-right: 1px solid #20537A;
		border-left: 1px solid #20537A;
	}
	.review {
		position: relative;
		margin-top: 10px;
		background: white;
		width: max(20vw, 300px);
		min-width: max(25vw, 300px);
		height: 150px;
		max-height: 150px;
		margin-bottom: 10px;
		
		border-style: none solid solid none;
		border-width: 1px;
		border-color: black;
		box-shadow: 5px 5px 10px #20537A;
		background: white;//radial-gradient(#cedde9, #81A8C6);
	}
	.profilePicRev {
		width: 35px;
		height: 35px;
		border-radius: 35px;
		margin-right: 10px;
	}
	.profilePicRev:hover {
		z-index: 1;
		transform: scale(1.5, 1.5);
	}
	
	.top-review {
		margin-top: 10px;
		margin-left: 10px;
		text-align: left;
		font-size: 16px;
	}
	
	.center {
		
	}
	
	.bottom-review {
		position: absolute;
		bottom: 0;
		right: 10px;
		text-align: right;
		color: gray;
	}
	
	#review-popup {
		display: none;
		position: fixed;
		top: 0;
		bottom: 0;
		left: 0;
		right: 0;
		z-index: 2;
		background: rgba(0, 0, 0, 50%);
	}
	
	#review-form {
		border-radius: 20px;
		margin-top: 25vh;
		margin-left: 25vw;
		padding: 5vh 2.5vw 5vh 2.5vw;
		width: 45vw;
		height: 40vh;
		background: linear-gradient(to bottom right, #20537A, #38698E, #5481A4, #81A8C6);
		box-shadow: 5px 5px 10px #20537A;
		border: 2px solid #20537A;
	}
	
	#review-input {
		width: 38vw;
		height: 30vh;
		border-radius: 20px;
		padding: 2.5vh 1vw 2.5vh 1vw;
	}
	
	#review-submit {
		width: 38vw;
		background: linear-gradient(to top left, #20537A, #38698E, #5481A4, #81A8C6);
		color: white;
		margin-top: 5vh;
		padding: 2.5vh 1vw 2.5vh 1vw;
	}
	
	#review-submit:hover {
		background: linear-gradient(to bottom right, #20537A, #38698E, #5481A4, #81A8C6);
	}
	
	#create-post {
		position: absolute;
		bottom: 20px;
		right: 20px;
		text-decoration: none;
		color: #38698E;
		font-size: 24px;
		
	}
	
	@media only screen and (max-width: 700px) {
		#header {
			margin-left: 1vw;
			width: 98vw;
			margin-right: 0;
		}
		
		#profilePic {
			height: 20vmin;
			width: 20vmin;
			min-width: 25px;
			min-height: 25px;
			margin-top: 20px;
		}
		#header > #rightheader {
			right: 1vw;
			height: 175px;
		}
		#header {
			height: 175px;
		}
		#header > #rightheader > #upload {
			margin-top: 60px;
		}
		#header > #rightheader > form > #chatButton {
			margin-top: 60px;
		}
	}
	
	
	
	
</style>
<meta name="viewport" content="width=device-width,initial-scale=0.8">
<title><%- name%> / Staffer</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<head>
	<%- include('css/style'); %>
</head>

<script src="/socket.io/socket.io.js"></script>

<script>
	var own = '<%- own%>';
	var username = '<%- username%>'
	if (own) {
		var socket = io()
		socket.emit('self room', {username: username});
	}
	
	var getProfilePic = function() {
		$.get("/user-pic/" + username, function(url) {
			var image = document.getElementById("profilePic")
			if (url.length > 0) {
				image.src = url
			}
			
		});
	}
	getProfilePic()
</script>

<div id="header">
	<img id="profilePic"></img>
	<div id="info">
	<%if (name) {%>
		<p id="name" style="font-size: max(26px, 3vw); text-align:left;"><%= name %></p>
	<%}%>
	<%if (username) {%>
		<p id="username"><i>&#64<%= username %></i></p>
	<%}%>
	<%if (email) {%>
		<p id="email"><%= email %></p>
	<%}%>
	</div>
	<div id="rightheader">
		<%if (own) {%>
				<span style='position:absolute;right:20px;top:20px;'>
					<a href='/settings' style='text-decoration:none;color:#38698E;'>
						<i class="fa-solid fa-gear fa-lg"></i>
					</a>
				</span>
				<form id="upload" method="post" enctype="multipart/form-data">
					<label for="upload-photo">Edit Profile Pic<input type="file" id="upload-photo" name="photo" accept="image/*" /></label>
				</form>
				<button id="logout" onclick="window.location.href='/login'">Log Out</button>
				<%if (!user) { %>
					<a id="create-post" onclick="openCreatePost()"><i class="fa-regular fa-square-plus"></i></a>
				<%} %>
			
		<%} else {%>
			<form action="/chats/<%- username %>" method="post">
				<input type="submit" id="chatButton" value="Chat">
			</form>
			
			<button id="reviewButton" onclick='createReview()'>Review</button>
		<%}%>
	</div>
	
</div>
<div id="reviews-div"></div>
<div id='review-popup'>
	<form id='review-form' method='POST' action='/review'>
		<textarea name='review' id='review-input' type='paragraph' required></textarea><br>
		<input type='submit' value='Submit' id='review-submit'>
		<input type='hidden' name='username' value=<%= username%> >
	</form>
</div>
<script>
	var reviews = [];
	var username = '<%- username%>'
	var own = '<%- own%>'
	
	if (own && own == true) {
		var upload = document.getElementById("upload")
		
		upload.action = "/pics/" + username
		
		var photo = document.getElementById("upload-photo")
		photo.onchange = (e) => {
			upload.submit()
		}
	}

	var updateReviews = function() {
		var reviewsDiv = document.getElementById("reviews-div")
		$.get("/reviews?username=" + username, function(data) {
			if (!data) {
				return
			}
			data.forEach(function(review) {
				if (!reviews.includes(review._id)) {
					reviews.push(review._id);
					var reviewDiv = makeReview(review)
					reviewsDiv.appendChild(reviewDiv)
				}
				
			});
		});
		
		/*$.get("/stars?username=" + username, function(data) {
			console.log(data + " Stars")
			if (data && data != "undefined") {
				//rating.innerHTML = data + " stars";
			}
		});*/
	}
	
	var makeReview = function(review) {
		var reviewDiv = document.createElement("div")
		reviewDiv.className = "review"
		var top = document.createElement("div")
		top.className="top-review"
		var center = document.createElement("div")
		var bottom = document.createElement("div")
		reviewDiv.appendChild(top)
		reviewDiv.appendChild(center)
		reviewDiv.appendChild(bottom)
		
		center.style.display = "flex"
		center.style.justifyContent = "center"
		center.style.marginTop = "max(3vh, 20px)"
		center.style.marginLeft = "10px"
		center.style.marginRight = "10px"
		center.style.maxHeight = "75px"
		center.style.paddingRight = "10px"
		center.style.overflowY = "auto"
		
		bottom.className = "bottom-review"
		
		$.get("/user-pic/" + review.author, function(data) {
			if (data) {
				top.innerHTML = "<div style='float:left'><img src=" + data + " username=" + review.author + " class='profilePicRev'></img></div>"
				top.innerHTML += "<div username="+ review.author + ">" + review.name + "<i style='color:gray;font-family:Helvetica;'>@" + review.author + "</i></div>"
			} else {
				top.innerHTML = "<span class='profilePicRev' username=" + review.author + "><i class='fa fa-user fa-xl'></i></span>"
				top.innerHTML += review.name + "<i style='color:gray;font-family:Helvetica;'>@" + review.author + "</i>"
			}
			top.username = review.author
			top.onclick = (e) => {window.location.href='/profile/' + review.author}
			
		})
		top.innerHTML = "<span class='profilePicRev' username=" + review.author + "><i class='fa fa-user fa-xl'></i></span>"
		top.innerHTML += review.name + "<i style='color:gray'>@" + review.author + "</i>"
		top.style.fontFamily = 'Monaco'
		center.innerHTML = review.content
		var date = (Date.now() - new Date(review.created)) / 1000
		var dateString = Math.round(date + 1) + " seconds ago"
		if (date >= 59 && date < 60 * 60) {
			dateString = Math.round(date / 60) + " minutes ago"
		} else if (date >= 60 * 60 && date < 60 * 60 * 24) {
			dateString = Math.round(date / (60 * 60)) + " hours ago"
		} else if (date >= 60 * 60 * 24 && date < 60 * 60 * 24 * (365 + 0.25)) {
			dateString = Math.round(date / (60 * 60 * 24)) + " days ago"
		} else if (date >= 60 * 60 * 24 * (365 + 0.25)) {
			dateString = Math.round(date / (60 * 60 * 24 * (365 + 0.25))) + " years ago"
		}
		bottom.innerHTML = dateString
		return (reviewDiv)
	}
	
	updateReviews();
	
	var popup = document.getElementById('review-popup')
	
	var createReview = function() {
		popup.style.display = 'block'
	}
	
	window.onclick = function(e) {
		if (event.target == popup) {
			popup.style.display = 'none'
		} else if(event.target == postPopup) {
			postPopup.style.display = 'none'
		}
	}
</script>

<% if(user) { %>
<%- include('user'); %>
<% } else { %>
<%- include('restaurant'); %>
<% } %>