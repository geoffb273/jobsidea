
<head>
	<%- include('css/style'); %>
	
</head>

<body>
<style>

      #table {margin: 0; padding: 0; position: relative; top: 0; width: 100%; bottom: 3rem; overflow-y: auto}
      #table > tr { padding: 0px;}
      #join {float:right; margin-right: 10px;}
      tr:nth-child(even) { background-color: #e9f4ff; }
</style>
<p id="test">Hi</p>
<title>Chats</title>
<h1>Chats</h1>
<div class="post">
  <table id = "table"></table>
</div>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>
	
	var table = document.getElementById("table");
	
	var chats = [];
	var chatIds = []
	var username = '<%- username %>'
	var limit = 10;
	
	var enterChat = function() {
		location.href = "/chat?chatId=" + this.chatId;
	}
	
	var updateChats = function() {
		
    	$.get("/my-chats?limit=" + limit, function(data) {
    		var chats = data
    		for (var i = 0; i < chats.length; i++) {
    			var chat = chats[i];
    			var chatName = chat.id.split("@").filter(function(name) {
					return name != username
				})[0]
    			if (!chatIds.includes(chat.id) || (chatIds.indexOf(chat.id) != i && i >= table.rows)) {
    				chatIds.push(chat.id);
    				chats.push(chat)
    				var row = table.insertRow(i);
					var cell1 = row.insertCell(0);
					cell1.innerHTML = chatName;
					var cell2 = row.insertCell(1);
					var button = document.createElement("button");
					button.innerHTML = "Chat";
					button.id = "join";
					button.chatId = chat.id;
					button.onclick = enterChat;
					cell2.appendChild(button);
    			} else if (chatIds.indexOf(chat.id) != i && i < table.rows) {
    				var row = table.rows[i];
    				row.cells[0].innerHTML = chatName;
    				var button = row.cells[1].getElementsByTagName("button")[0];
    				button.chatId = chat.id
    			}
    		}
    	})
  	};
  	
  	var refresh = function() {
  		limit += 10
  		updateChats();
  	}
	
	/*chats.forEach(chat => {
		chatIds.push(chat.id);
		var row = table.insertRow(table.rows.length);
		row.id = chat.id;
		var cell1 = row.insertCell(0);
		var chatName = chat.id.split("@").filter(function(name) {
			return name == username
		})[0]
		cell1.innerHTML = chatName;
		var cell2 = row.insertCell(1);
		var button = document.createElement("button");
		button.innerHTML = "Join Chat";
		button.id = "join";
		button.chatId = chat.id;
		button.onclick = enterChat;
		cell2.appendChild(button);
	});*/
	updateChats();
</script>


</body>